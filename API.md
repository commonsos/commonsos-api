# Commons OS API documentation

Commons OS provides an HTTP based API implementing elements of RESTful style. 

API is protected with user authentication and authorization. That includes server side sessions.
To access an protected API the requester must provide valid session id as value for cookie **JSESSIONID**. Session id is generated during successful authentication (see _POST /login_).

Common HTTP response codes:
* 200 - successful request
* 401 - user has no valid session
* 403 - user don't have access to requested data
* 468 - an error with server side message that should be displayed to user
* 500 - any other unexpected error

##Communities API

###GET /communities
Retrieves list of existing communities. Doesn't require valid session.
######Response: 
```json
[
  {
    "id": 1,
    "name": "Kaga city"
  },
  {
    "id": 2,
    "name": "Shibuya People"
  }
]
```



##Session management API

###POST /login
Authenticates user. Successful authentication creates new user session and responds with new session identifier (cookie **JSESSIONID**). 
######Request body
```json
{
  username: "username",
  password: "password"
}
```


######Response: basic data of authenticated user
```json
{
  "id": 1,
  "admin": true,
  "fullName": "Community Coordinator",
  "firstName": "Coordinator",
  "lastName": "Community",
  "description": "Contact me if you have problem to solve.",
  "balance": 11579.50,
  "location": "Kaga, Ishikawa Prefecture, Japan",
  "avatarUrl": "https://commonsos-app-dev.s3.amazonaws.com/1ff39"
}
```

###POST /logout
Invalidates and removes user session from server.



##Users API

###POST /create-account
Creates new user in system. Successful request stores user in database, assigns requested community to him and
 creates user's Ethereum wallet with balance of 0. 

Provided username must be unique. 
Community id must be selected from existing values read using _/communities_ request. 

######Request:
```json
{
  "username": "john",
  "password": "secret text",
  "firstName": "John",
  "lastName": "Doe",
  "description": "A man from the moon",
  "location": "Tokyo",
  "communityId": 1
}
```

######Response: basic data of created user
```json
{
  "id": 11,
  "admin": false,
  "fullName": "Doe John",
  "firstName": "John",
  "lastName": "Doe",
  "description": "A man from the moon",
  "balance": 0,
  "location": "Tokyo"
}
```

###GET /user
Read data of current user. User is identified from session. 
######Response: basic data of current user
```json
{
  "id": 11,
  "admin": false,
  "fullName": "Doe John",
  "firstName": "John",
  "lastName": "Doe",
  "description": "A man from the moon",
  "balance": 0,
  "location": "Tokyo"
}
```

###GET /users/:id
Read data of specified user. For requester having admin privilege extended set of data is returned.
######Parameters in URL:
```
id - identifier of the requested user.

```
 
######Response: (requester has admin privilege)
```json
{
  "id": 11,
  "admin": false,
  "fullName": "Doe John",
  "firstName": "John",
  "lastName": "Doe",
  "description": "A man from the moon",
  "balance": 0,
  "location": "Tokyo",
  "avatarUrl":  "https://commonsos-app-dev.s3.amazonaws.com/0bb684fc-4722-438c-adfc-a9028b983dc9"
}
```
######Response: (requester does not have admin privilege)
```json
{
  "id": 11,
  "fullName": "Doe John",
  "description": "A man from the moon",
  "location": "Tokyo",
  "avatarUrl":  "https://commonsos-app-dev.s3.amazonaws.com/0bb684fc-4722-438c-adfc-a9028b983dc9"
}
```


###POST /users/:id
Updates user data.
######Parameters in URL:
```
id - identifier of the requested user.

```
######Request:
```
{
  "id": 11,
  "firstName": "John2",
  "lastName": "Doe2",
  "description": "A man from the moon2",
  "location": "Tokyo2"
}
```
######Response: (basic data of updated user)
```json
{
  "id": 11,
  "admin": false,
  "fullName": "Doe2 John2",
  "firstName": "John2",
  "lastName": "Doe2",
  "description": "A man from the moon2",
  "balance": 0,
  "location": "Tokyo2"
}
```

###POST /users/:id/avatar
Updates user's avatar photo. Requires form-urlencoded content type:
```header
Content-Type: application/x-www-form-urlencoded
```

######Parameters in URL:
```
id - identifier of the requested user.

```
######Request: (image content encoded as data url)
```url
data:image/jpeg;base64,/9j/4AAQSkZJRgABAQ...
```
######Response: (Permanent URL which can be used to download image)
```text
https://commonsos-app.s3.amazonaws.com/6cbee65b-6733
```

###POST /users/:id/mobile-device
Registers user's mobile phone **Push-Notification token** (identifier). Token must be generated by phone's Push Notification subsystem. 

One user can have exactly one token. If a user registers new token, old token is removed from user profile and not used anymore.

If a phone user uses two Commons OS usernames in a single phone, both usernames get the same token due to Push Notification nature.
In that case the phone user receives notifications sent to two different users. 

Push notification is sent to user in two cases:
* new message in message thread
* Ethereum transaction is completed 

######Parameters in URL:
```
id - identifier of the requested user.

```
######Request:
```json
{
  "pushNotificationToken": "token-value"
}
```
######Response. 
```
none
```

###GET /users?q=pattern
Searches for users by provided pattern. Search is limited to requesting user community. 
 
For successful match the pattern must be a substring of first name or last name. Search is case insensitive. 

######Parameters in URL:
```
pattern - search pattern. 

```

######Response: list of matching users
```json
[
  {
    "id": 11,
    "fullName": "Doe John",
    "description": "A man from the moon",
    "location": "Tokyo",
    "avatarUrl": "https://commonsos-app.s3.amazonaws.com/6cbee65b-6733-43b1"
  }
]

```


##Advertisement API

###POST /ads
Creates new advertisement on requesting user community. Advertisement is immediately visible to other users. 
Advertisement type can be "WANT" or "GIVE". For type "WANT" only advertisement publisher can make a payment. 
For type "GIVE" other users can make a payment.
######Request:
```json
{
  "type": "WANT",
  "title": "good stuff",
  "description": "very good stuff",
  "amount": "20.50",
  "location": "Tokyo"
}
```
######Response:
```json
{
  "id": 8,
  "createdBy": {
    "id": 1,
    "fullName": "Doe John",
    "description": "A man from the moon",
    "location": "Tokyo",
    "avatarUrl": "https://commonsos-app-dev.s3.amazonaws.com/1ff398b0"
  },
  "title": "good stuff",
  "description": "very good stuff",
  "points": 20.50,
  "location": "Tokyo",
  "own": true,
  "payable": true,
  "createdAt": "2018-08-27T10:55:21.676Z",
  "type": "WANT"
}
```

###GET /ads
List of all advertisements available in requester community.

######Response:
```json
[
  {
    "id": 3,
    "createdBy": {
      "id": 4,
      "fullName": "Doe John",
      "description": "A man from the moon",
      "location": "Tokyo",
      "avatarUrl": "https://commonsos-app-dev.s3.amazonaws.com/1ff398b0"
    },
    "title": "Need soya",
    "description": "Bring me lot of soya!",
    "points": 20.00,
    "location": "Tokyo",
    "createdAt": "2018-07-09T07:01:52.675Z",
    "photoUrl": "https://commonsos-app-dev.s3.amazonaws.com/79857983",
    "type": "WANT"
  },
  ...
]
```

###GET /ads/:id
Read details of a specified advertisement.
######Parameters in URL:
```
id - identifier or requested advertisement.
```
######Response:
```json
{
  "id": 3,
  "createdBy": {
    "id": 4,
    "fullName": "Doe John",
    "description": "A man from the moon",
    "location": "Tokyo",
    "avatarUrl": "https://commonsos-app-dev.s3.amazonaws.com/1ff398b0"
  },
  "title": "Need soya",
  "description": "Bring me lot of soya!",
  "points": 20.00,
  "location": "Tokyo",
  "createdAt": "2018-07-09T07:01:52.675Z",
  "photoUrl": "https://commonsos-app-dev.s3.amazonaws.com/79857983",
  "type": "WANT"
}
```

###POST /ads/:id/photo
Sets photo for advertisement. An advertisement can have exactly one photo. If advertisement already has photo, new one replaces old one.
Requires form-urlencoded content type:
```header
Content-Type: application/x-www-form-urlencoded
```

#######Parameters in URL
```text
id - identifier of updated advertisement.
```
######Request: (image content encoded as data url)
```url
data:image/jpeg;base64,/9j/4AAQSkZJRgABAQ...
```
######Response: (Permanent URL which can be used to download image)
```text
https://commonsos-app.s3.amazonaws.com/6cbee65b-6764
```

##User wallet API

###GET /balance
Available balance of requesting user. Is calculated as user balance in Ethereum network subtracted total amount of pending transactions posted by the user.

######Response:
```json
10.20
```

###GET /transactions
List of transactions from requesting user wallet. Includes (pending) transactions which are not yet confirmed by Ethereum network.
Pending transactions are marked as field _completed_ set to _false_. Field _debit_ is set to _true_ if requesting user is in remitter's role.

######Response:
```json
[
  {
    "remitter": {
      "id": 1,
      "fullName": "Community Coordinator",
      "description": "IContact me if you have problem to solve.",
      "location": "Tokyo",
      "avatarUrl": "https://commonsos-app.s3.amazonaws.com/1ff398b0"
    },
    "beneficiary": {
      "id": 4,
      "fullName": "Takahashi Haru",
      "description": "Good guy",
      "location": "Tokyo",
      "avatarUrl": "https://commonsos-app.s3.amazonaws.com/1ff654783"
    },
    "amount": 2000.00,
    "description": "member top-up",
    "createdAt": "2018-07-27T12:15:52.766Z",
    "completed": true,
    "debit": true
  }
]
```

###POST /transactions
A request to deduct amount of tokens from requesting user wallet and transfer to user wallet marked with _beneficiaryId_. 

The API posts transaction to Ethereum network. The API does not wait until Ethereum network confirms transaction. 
New transaction is immediately visible in both user's transactions list marked as _pending_.

  
######Request:
* amount - amount must be a positive number smaller or equal to user's available balance (see _GET /balance_).
* adId - related advertisement id (if available). Advertisement id is also used for validation. For example in case of 
advertisement with type of **WANT** only advertisement author can make a payment. 
* beneficiaryId - identifier of the user receiving specified amount of tokens. Beneficiary must belong to the same community with API requester. 

```json
{
  "description": "transaction comments",
  "amount": 2000.00,
  "beneficiaryId": 2,
  "adId": 1
}
```
######Response:
```
none
```


##Messaging API
###POST /message-threads/for-ad/:adId
Retrieves (and creates if not present) message thread related to specified advertisement. 
Message thread counterparty is the user who is the author of specified advertisement.
The request creates non-group (private) type of thread. 

######Parameters in URL:
```
adId - identifier of the advertisement which author is counterparty in requested message thread.

```
######Response:
* ad - details of related advertisement.
* creator - the user who created the thread.
* parties - all users participating in thread except creator user.
* counterparty - first participant found who is not the requesting user.
* lastMessage - latest message in thread.
* unread - true if a message was sent to thread after user has last time requested thread messages. 
* group - false referres to private type of thread. Only two users participate in private thread. 

```json
{
  "id": 5,
  "ad": {
    "id": 1,
    "createdBy": {
      "id": 2,
      "fullName": "Sato Haruto",
      "description": "I am an Engineer",
      "location": "Tokyo",
      "avatarUrl": "http://photo"
    },
    "title": "House cleaning",
    "description": "Vacuum cleaning",
    "points": 1299.01,
    "location": "Kaga city",
    "own": false,
    "payable": true,
    "createdAt": "2018-07-09T07:01:52.663Z",
    "photoUrl": "http://photo",
    "type": "GIVE"
  },
  "title": "House cleaning",
  "parties": [
    {
      "id": 2,
      "fullName": "Sato Haruto",
      "description": "I am an Engineer",
      "location": "Tokyo",
      "avatarUrl": "http://photo"
    }
  ],
  "creator": {
    "id": 1,
    "fullName": "Community Coordinator",
    "description": "Im a coordinator",
    "location": "Tokyo",
    "avatarUrl": "http://photo"
  },
  "counterParty": {
    "id": 2,
    "fullName": "Sato Haruto",
    "description": "I am an Engineer",
    "location": "http://photo",
    "avatarUrl": "http://photo"
  },
  "lastMessage": {
    "id": 57,
    "createdAt": "2018-07-25T08:14:34.479Z",
    "createdBy": 2,
    "text": "Dummy text"
  },
  "unread": false,
  "group": false,
  "createdAt": "2018-07-09T10:31:05.215Z"
}
```

###POST /message-threads/group
Creates chat with multiple users (group chat). Group chat allows adding or removing participants. 
######Request:
* memberIds - list of user ids participating in chat.
```json
{
  "memberIds": [
    4,
    3
  ],
  "title": "Message thread title"
}
```
######Response:
* creator - the user who created the thread.
* parties - all users participating in thread except creator user.
* counterparty - first participant found who is not the requesting user.
* lastMessage - latest message in thread.
* unread - true if a message was sent to thread after user has last time requested thread messages. 
* group - true referrers to group type of thread.
```json
{
  "id": 14,
  "title": "",
  "parties": [
    {
      "id": 4,
      "fullName": "Takahashi Haru",
      "description": "Lets play poker",
      "location": "Kaga",
      "avatarUrl": "http://image"
    },
    {
      "id": 3,
      "fullName": "Suzuki Riku",
      "description": "I need personal assistance daily basis.",
      "location": "Kaga",
      "avatarUrl": "http://image"
    }
  ],
  "creator": {
    "id": 1,
    "fullName": "Community Coordinator",
    "description": "Contact me if you have problem to solve.",
    "location": "Kaga",
    "avatarUrl": "http://image"
  },
  "counterParty": {
    "id": 4,
    "fullName": "Takahashi Haru",
    "description": "Lets play poker!",
    "location": "Kaga, Ishikawa Prefecture, Japan",
    "avatarUrl": "http://image"
  },
  "unread": false,
  "group": true,
  "createdAt": "2018-08-27T12:09:09.172Z"
}
```

###POST /message-threads/:id/group
Updates group chat title and participants.
######Parameters in URL:
```
id - identifier of the requested message thread.

```
 ######Request:
Desired final state of message thread. To remove a participant omit his user id from _memberIds_.
To add new participant add his user id to _memberIds_.
To keep user in chat add his user id to  _memberIds_.
```json
{
  "memberIds": [
    4,
    3
  ],
  "title": "New thread title"
}
```
######Response:
Final state of message thead. See result of _POST /message-threads/group_.


###GET /message-threads/unread-count
Number of threads that have unread messages by requesting user. A thread is considered as unread 
if a message was sent to thread after user has last time requested for thread messages.

######Response:
```json
{
  "count": 3
}
```

###GET /message-threads/:id
Read details of specified thread. Requesting user must be a participant in specified message thread.
######Parameters in URL:
```
id - identifier of the requested message thread.

```
 
######Response:
See result of _POST /message-threads/group_.

###GET /message-threads
List of all message threads the requesting user is participating in.

######Response:
List of message threads. A thead has identical structure as in result of _POST /message-threads/group_. 
```json
[
  thread1, thread2
]
```

###POST /message-threads/:id/messages
Post a message to message thead. Requesting user must be a participant in specified thread.
######Parameters in URL:
```
id - identifier of the requested message thread.

```
######Request:
```json
{
  "threadId": "7",
  "text": "message contents"
}
```
######Response:
Details of posted message.
```json
{
  "id": 65,
  "createdAt": "2018-08-27T12:34:08.493Z",
  "createdBy": 1,
  "text": "message contents"
}
```

###GET /message-threads/:id/messages
List of all posted messages in specified thread. Requesting user must be a participant in specified thread.
######Parameters in URL:
```
id - identifier of the requested message thread.

```

######Response:
```json
[
  {
    "id": 10,
    "createdAt": "2018-07-09T10:31:08.501Z",
    "createdBy": 1,
    "text": "Hello"
  },
  {
    "id": 23,
    "createdAt": "2018-07-12T07:45:39.884Z",
    "createdBy": 2,
    "text": "Hi!"
  }
]
```
